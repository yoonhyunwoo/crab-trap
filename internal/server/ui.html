<!DOCTYPE html>
<html>
<head>
    <title>Crab Trap</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: #333; margin-bottom: 20px; }
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat { background: #fff; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat h3 { margin: 0 0 10px 0; color: #666; font-size: 14px; text-transform: uppercase; }
        .stat .value { font-size: 32px; font-weight: bold; color: #333; }
        .charts { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px; }
        .chart-container { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .chart-container.full { grid-column: span 2; }
        .chart-container h3 { margin-top: 0; color: #333; }
        .logs { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .log-entry { border-bottom: 1px solid #eee; padding: 15px 0; }
        .log-entry:last-child { border-bottom: none; }
        .timestamp { color: #666; font-size: 14px; }
        .method { font-weight: bold; color: #d73a49; }
        .url { font-family: monospace; color: #005cc5; }
        .details { margin-top: 10px; font-size: 13px; color: #444; }
        button { background: #005cc5; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; }
        button:hover { background: #004e8c; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Crab Trap</h1>
        <div class="stats">
            <div class="stat">
                <h3>Total Requests</h3>
                <div class="value" id="total">0</div>
            </div>
            <div class="stat">
                <h3>Unique IPs</h3>
                <div class="value" id="unique-ips">0</div>
            </div>
            <div class="stat">
                <h3>POST Requests</h3>
                <div class="value" id="post">0</div>
            </div>
            <div class="stat">
                <h3>Last Request</h3>
                <div class="value" id="last">-</div>
            </div>
        </div>
        <button onclick="refreshLogs()">Refresh Logs</button>
        <div class="charts">
            <div class="chart-container full">
                <h3>Requests Over Time</h3>
                <canvas id="timelineChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>HTTP Methods</h3>
                <canvas id="methodChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Top IP Addresses</h3>
                <canvas id="ipChart"></canvas>
            </div>
        </div>
        <div class="logs" id="logs"></div>
    </div>
    <script>
        let timelineChart, methodChart, ipChart;

        async function loadLogs() {
            const response = await fetch('/logs');
            const data = await response.json();
            
            const logsContainer = document.getElementById('logs');
            logsContainer.innerHTML = '';
            
            let total = 0;
            let postCount = 0;
            const ips = new Set();
            const ipCounts = new Map();
            const methodCounts = new Map();
            const timelineData = new Map();
            let lastTime = '-';
            
            data.logs.forEach(log => {
                total++;
                const ip = log.remote_addr.split(':')[0];
                ips.add(ip);
                ipCounts.set(ip, (ipCounts.get(ip) || 0) + 1);
                
                if (log.method === 'POST') postCount++;
                
                methodCounts.set(log.method, (methodCounts.get(log.method) || 0) + 1);
                
                const timestamp = new Date(log.timestamp);
                const hourKey = timestamp.getHours();
                timelineData.set(hourKey, (timelineData.get(hourKey) || 0) + 1);
                
                lastTime = timestamp.toLocaleTimeString();
                
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                const timestampDiv = document.createElement('div');
                timestampDiv.className = 'timestamp';
                timestampDiv.textContent = timestamp.toLocaleString();
                entry.appendChild(timestampDiv);
                
                const div = document.createElement('div');
                const methodSpan = document.createElement('span');
                methodSpan.className = 'method';
                methodSpan.textContent = log.method;
                div.appendChild(methodSpan);
                
                div.appendChild(document.createTextNode(' '));
                
                const urlSpan = document.createElement('span');
                urlSpan.className = 'url';
                urlSpan.textContent = log.url;
                div.appendChild(urlSpan);
                
                entry.appendChild(div);
                
                const details = document.createElement('div');
                details.className = 'details';
                details.textContent = 'Remote: ' + log.remote_addr + ' | User-Agent: ' + (log.user_agent || 'N/A');
                entry.appendChild(details);
                
                if (log.body) {
                    const bodyDiv = document.createElement('div');
                    bodyDiv.className = 'details';
                    bodyDiv.textContent = 'Body: ' + log.body.substring(0, 200) + '...';
                    entry.appendChild(bodyDiv);
                }
                
                logsContainer.appendChild(entry);
            });
            
            document.getElementById('total').textContent = total;
            document.getElementById('unique-ips').textContent = ips.size;
            document.getElementById('post').textContent = postCount;
            document.getElementById('last').textContent = lastTime;

            updateCharts(methodCounts, ipCounts, timelineData);
        }
        
        function updateCharts(methodCounts, ipCounts, timelineData) {
            const hours = Array.from({length: 24}, (_, i) => i);
            const timelineValues = hours.map(h => timelineData.get(h) || 0);
            
            if (timelineChart) {
                timelineChart.data.datasets[0].data = timelineValues;
                timelineChart.update();
            } else {
                timelineChart = new Chart(document.getElementById('timelineChart'), {
                    type: 'line',
                    data: {
                        labels: hours.map(h => h + ':00'),
                        datasets: [{
                            label: 'Requests',
                            data: timelineValues,
                            borderColor: '#005cc5',
                            backgroundColor: 'rgba(0, 92, 197, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }

            const methodLabels = Array.from(methodCounts.keys());
            const methodValues = Array.from(methodCounts.values());
            
            if (methodChart) {
                methodChart.data.labels = methodLabels;
                methodChart.data.datasets[0].data = methodValues;
                methodChart.update();
            } else {
                methodChart = new Chart(document.getElementById('methodChart'), {
                    type: 'doughnut',
                    data: {
                        labels: methodLabels,
                        datasets: [{
                            data: methodValues,
                            backgroundColor: ['#005cc5', '#28a745', '#ffc107', '#dc3545']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            }

            const sortedIPs = Array.from(ipCounts.entries()).sort((a, b) => b[1] - a[1]).slice(0, 10);
            const ipLabels = sortedIPs.map(([ip]) => ip);
            const ipValues = sortedIPs.map(([, count]) => count);
            
            if (ipChart) {
                ipChart.data.labels = ipLabels;
                ipChart.data.datasets[0].data = ipValues;
                ipChart.update();
            } else {
                ipChart = new Chart(document.getElementById('ipChart'), {
                    type: 'bar',
                    data: {
                        labels: ipLabels,
                        datasets: [{
                            label: 'Requests',
                            data: ipValues,
                            backgroundColor: '#005cc5'
                        }]
                    },
                    options: {
                        responsive: true,
                        indexAxis: 'y',
                        scales: {
                            x: { beginAtZero: true }
                        }
                    }
                });
            }
        }
        
        function refreshLogs() {
            loadLogs();
        }
        
        loadLogs();
        setInterval(loadLogs, 10000);
    </script>
</body>
</html>
